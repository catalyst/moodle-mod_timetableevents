{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JS for forms.\n *\n * @package   mod_timetableevents\n * @copyright 2022 onwards Catalyst IT EU {@link https://catalyst-eu.net}\n * @author    Sarah Cotton <sarah.cotton@catalyst-eu.net>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['core/ajax', 'core/str', 'jquery'], function(ajax, str, $) {\n\n    return {\n        /**\n         * Initialize JS for forms.\n         * @access public\n         * @param {Object} params\n         */\n        course: function(course, sesskey) {\n            const terms = JSON.parse(document.querySelector('[name=\"termsjson\"]').value);\n            const acadyear = document.getElementById('id_academicyear');\n            const term = document.getElementById('id_term');\n            const group = document.getElementById('id_groupoverrides');\n            const group_selections = document.getElementById('groupoverrides_selections');\n\n            var event = new Event('change', { bubbles: true });\n\n            acadyear.addEventListener('change',function(){\n                const yearid = document.getElementById(\"id_academicyear\").value;\n                const year = terms[yearid];\n                let list = [];\n\n                // Construct new options list for selected year.\n                for (const key in year) {\n                    list[year[key].termid] = year[key].termname + ' ' + year[key].startdateformatted\n                            + ' - ' + year[key].enddateformatted;\n                }\n\n                // Remove current options from select.\n                const id_term = document.getElementById(\"id_term\");\n                id_term.options.length = 0;\n\n                // Replace select options.\n                for (const key in list) {\n                    id_term.options[id_term.options.length] = new Option(list[key], key);\n                }\n\n                // Trigger update of term start date.\n                if (!localStorage.getItem('tte_academicyear')) {\n                    term.dispatchEvent(event);\n                }\n\n            });\n\n            term.addEventListener('change',function(){\n                const year = document.getElementById('id_academicyear').value;\n                const startingtermid = document.getElementById('id_term').value;\n\n                document.getElementById('id_teachingstartdate_day').value = parseInt(terms[year][startingtermid]['day'], 10);\n                document.getElementById('id_teachingstartdate_month').value = parseInt(terms[year][startingtermid]['month'], 10);\n                document.getElementById('id_teachingstartdate_year').value = terms[year][startingtermid]['year'];\n\n            });\n\n            if (group_selections) {\n                group_selections.addEventListener('click',function(e){\n                    // Get value of clicked element and add to hidden element\n                    // to pass back to the form.\n                    let removegroup = e.target.getAttribute('data-value');\n                    let removegroupelement = e.target;\n                    let removeoverrides = document.querySelector('[name=\"removeoverrides\"]');\n                    removeoverrides.value = removeoverrides.value + ',' + removegroup;\n\n                    // Hide element.\n                    removegroupelement.style.display = \"none\";\n                });\n            }\n\n            if (group) {\n                group.addEventListener('click',function(){\n\n                    // Save currently set data to Web Storage API.\n                    localStorage.setItem('tte_academicyear', document.getElementById('id_academicyear').value);\n                    localStorage.setItem('tte_term', document.getElementById('id_term').value);\n                    localStorage.setItem('tte_teachingstartdate_day', document.getElementById('id_teachingstartdate_day').value);\n                    localStorage.setItem('tte_teachingstartdate_month',\n                        document.getElementById('id_teachingstartdate_month').value);\n                    localStorage.setItem('tte_teachingstartdate_year', document.getElementById('id_teachingstartdate_year').value);\n                    localStorage.setItem('tte_firstsection', document.getElementById('id_firstsection').value);\n                    localStorage.setItem('tte_teachinginverval', document.getElementById('id_teachinginverval').value);\n\n                    const readingweek = document.getElementById('id_readingweek');\n                    localStorage.setItem('tte_readingweek',\n                        Array.from(readingweek.querySelectorAll(\"option:checked\"),v => v.value));\n\n                    const excluded = document.getElementById('id_excluded');\n                    localStorage.setItem('tte_excluded', Array.from(excluded.querySelectorAll(\"option:checked\"),v => v.value));\n                    localStorage.setItem('tte_footertext', document.getElementById('id_footertext').value);\n\n                    // Redirect user to group overrides settings.\n                    let year = document.getElementById('id_academicyear').value;\n                    location.href = '/mod/timetableevents/group.php?id=' + course + '&year=' + year + '&sesskey=' + sesskey;\n                });\n            }\n\n            // Check if Web Storage data has been set and load if present.\n            if (localStorage.getItem('tte_academicyear')) {\n\n                document.getElementById('id_academicyear').value = localStorage.getItem('tte_academicyear');\n                // Trigger the acad year event so we have data for the correct year in the term dropdown.\n                acadyear.dispatchEvent(event);\n                document.getElementById('id_term').value = localStorage.getItem('tte_term');\n                document.getElementById('id_teachingstartdate_day').value = localStorage.getItem('tte_teachingstartdate_day');\n                document.getElementById('id_teachingstartdate_month').value = localStorage.getItem('tte_teachingstartdate_month');\n                document.getElementById('id_teachingstartdate_year').value = localStorage.getItem('tte_teachingstartdate_year');\n                document.getElementById('id_firstsection').value = localStorage.getItem('tte_firstsection');\n                document.getElementById('id_teachinginverval').value = localStorage.getItem('tte_teachinginverval');\n\n                const readingweek = document.getElementById('id_readingweek');\n                for (let i = 0; i < readingweek.options.length; i++) {\n                    readingweek.options[i].selected =\n                        localStorage.getItem('tte_readingweek').indexOf(readingweek.options[i].value) >= 0;\n                }\n\n                var excluded = document.getElementById('id_excluded');\n                for (let i = 0; i < excluded.options.length; i++) {\n                    excluded.options[i].selected = localStorage.getItem('tte_excluded').indexOf(excluded.options[i].value) >= 0;\n                }\n                document.getElementById('id_footertext').value = localStorage.getItem('tte_footertext');\n\n                remove_storage_keys();\n\n            }\n        },\n\n        group: function() {\n            const terms = JSON.parse(document.querySelector('[name=\"termsjson\"]').value);\n            const term = document.getElementById('id_startingtermid');\n            let hiddenyear = document.querySelector('[name=\"year\"]').value;\n\n            term.addEventListener('change',function(){\n                let startingtermid = document.getElementById('id_startingtermid').value;\n\n                document.getElementById('id_teachingstartdate_day').value = parseInt(terms[hiddenyear][startingtermid]['day'], 10);\n                document.getElementById('id_teachingstartdate_month').value =\n                    parseInt(terms[hiddenyear][startingtermid]['month'], 10);\n                document.getElementById('id_teachingstartdate_year').value = terms[hiddenyear][startingtermid]['year'];\n\n            });\n\n            window.addEventListener('beforeunload', function() {\n                let url = document.activeElement.href;\n                // If we're moving away from the course settings page without saving, remove the storage keys.\n                if (!url.includes('/mod/timetableevents/course.php')) {\n                    remove_storage_keys();\n                }\n            });\n        },\n\n        instance: function() {\n\n            const courseoverride = document.getElementById('id_courseoverride');\n            const nogroups = str.get_string('modsetting:nogroups', 'timetableevents');\n\n            courseoverride.addEventListener('change',function(){\n\n                let courseid = document.getElementById('id_courseoverride').value;\n\n                let request = {\n                    methodname: 'mod_timetableevents_select_groups',\n                    args: {\n                        courseid: courseid\n                    }\n                };\n\n                let promise = ajax.call([request])[0];\n\n                promise.then(\n                    function(value) {\n                        // Remove current options from select.\n                        const id_groupid = document.getElementById(\"id_groupid\");\n                        id_groupid.options.length = 0;\n\n                        // Replace select options.\n                        if (value.length > 0) {\n                            for (const key in value) {\n                                id_groupid.options[id_groupid.options.length] = new Option(value[key].name, value[key].id);\n                            }\n                            id_groupid.disabled = false;\n                        } else {\n                            $.when(nogroups).done(function(localizednogroups) {\n                                id_groupid.options[id_groupid.options.length] =\n                                    new Option(localizednogroups, 0);\n                            });\n\n                            id_groupid.disabled = true;\n                        }\n                    }\n                );\n            });\n        }\n    };\n});\n\nfunction remove_storage_keys() {\n    localStorage.removeItem('tte_academicyear');\n    localStorage.removeItem('tte_term');\n    localStorage.removeItem('tte_teachingstartdate_day');\n    localStorage.removeItem('tte_teachingstartdate_month');\n    localStorage.removeItem('tte_teachingstartdate_year');\n    localStorage.removeItem('tte_firstsection');\n    localStorage.removeItem('tte_teachinginverval');\n    localStorage.removeItem('tte_readingweek');\n    localStorage.removeItem('tte_excluded');\n    localStorage.removeItem('tte_footertext');\n}\n"],"names":["remove_storage_keys","localStorage","removeItem","define","ajax","str","$","course","sesskey","terms","JSON","parse","document","querySelector","value","acadyear","getElementById","term","group","group_selections","event","Event","bubbles","addEventListener","yearid","year","list","key","termid","termname","startdateformatted","enddateformatted","id_term","options","length","Option","getItem","dispatchEvent","startingtermid","parseInt","e","removegroup","target","getAttribute","removegroupelement","removeoverrides","style","display","setItem","readingweek","Array","from","querySelectorAll","v","excluded","location","href","i","selected","indexOf","hiddenyear","window","activeElement","includes","instance","courseoverride","nogroups","get_string","request","methodname","args","courseid","call","then","id_groupid","name","id","disabled","when","done","localizednogroups"],"mappings":"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"}